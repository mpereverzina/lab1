const fs = require('fs')

var inp = [
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 12, 11, 10,  9, 8,  7, 6, 5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10,  9,  8,  7, 6,  5, 4, 3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 10,  9,  8,  7,  6,  5, 4,  3, 2, 1,
           1, 2, 3, 4, 5, 6, 7, 8, 9, 10,  9,  8,  7,  6,  5,  4,  3, 2,  1
          ];

function sleep(delay) {
    var start = new Date().getTime();
    while (new Date().getTime() < start + delay);
}

let t1 = 0
let t2 = 0
let led_state = false
let raw = 0
let M_avg = 0
let bpm = 0
let i = 0
M_avg = inp[i];

const file = './data/bpm.txt'

while (true) {
    i++;
    if (i === inp.length) {
        break;
    }

    raw = inp[i];

    M_avg = 200 * raw / 1000 + 800 * M_avg / 1000
    if (raw >= M_avg) {
        if (led_state == false) {
            t2 = new Date();
            led_state = true;

            if (t1 > 0) {
                bpm = 60 * 1000 * 1000 / ((t2 - t1) * 1000);
                console.log (bpm);

                fs.writeFileSync(file, bpm, {encoding: 'utf8', flag: 'w'});
            }

            t1 = t2
        }
    } else {
        if (led_state == true) {
            led_state = false
        }
    }

    sleep(20);
}
